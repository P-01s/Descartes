#!/usr/bin/env ruby
# encoding: UTF-8
##
#            DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
#                    Version 2, December 2004
# 
# Everyone is permitted to copy and distribute verbatim or modified
# copies of this license document, and changing it is allowed as long
# as the name is changed.
# 
#            DO WHAT THE FUCK YOU WANT TO PUBLIC LICENSE
#   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
# 
#  0. You just DO WHAT THE FUCK YOU WANT TO.
##

require 'descartes'

nickname  = ARGV[0]     || 'Descartes'
server    = ARGV[1]     || 'irc.rizon.net'
channels  = ARGV[2..-1] || ['#aggvistnurummor']
plugins   = Descartes.load

Cinch::Bot.new {
  configure do |c|
    c.nick     = nickname
    c.realname = 'Descartes'
    c.user     = 'Descartes'
    c.server   = server
    c.channels = channels
    
    c.plugins.plugins  = [Cinch::Plugins::Login] + plugins
    c.plugins.options[Cinch::Plugins::Login] = { :password => 'dat_password' }
  end

  on :message, '!help' do |m|
    m.bot.plugins.each { |plugin|
      plugin.handlers.each { |handler|
        pattern = handler.pattern
        name    = plugin.to_s.split('::')[1].split(?:)[0]

        prefix = case pattern.prefix
          when Regexp then pattern.prefix.source
          when String then pattern.prefix
          else            ''
        end

        suffix = case pattern.suffix
          when Regexp then pattern.suffix.source
          when String then pattern.suffix
          else             ''
        end

        regex = case pattern.pattern
          when Regexp then pattern.pattern.source
          when String then pattern.pattern
          else             ''
        end

        m.reply regex.empty? ? name : "#{name}: #{prefix}#{regex}#{suffix}"
      }
    }
  end

  on :message, '!è' do |m|
    m.reply ?È
  end

  on :message, '!t' do |m|
    m.reply ?~
  end

  on :message, '!"' do |m|
    m.reply '“…”'
  end

}.start
